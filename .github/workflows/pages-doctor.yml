name: Pages Doctor (Vite + React)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: read

jobs:
  pages-doctor:
    runs-on: ubuntu-latest
    env:
      REPO_NAME: ${{ github.event.repository.name }}
      OWNER: ${{ github.repository_owner }}
      EXPECTED_BASE: "/${{ github.event.repository.name }}/"

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4

      - name: Node setup
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Config checks (Vite base, Router basename)
        shell: bash
        run: |
          echo "## Pages Doctor ‚Äî Config" >> $GITHUB_STEP_SUMMARY
          echo "- Expected Vite base: \`${EXPECTED_BASE}\`" >> $GITHUB_STEP_SUMMARY

          if grep -R --line-number -E "base:\s*['\"]${EXPECTED_BASE}['\"]" vite.config.* >/dev/null 2>&1; then
            echo "‚úÖ Vite base OK" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Vite base mismatch. Add \`base: \"${EXPECTED_BASE}\",\` to vite.config.js" >> $GITHUB_STEP_SUMMARY
            echo "::warning title=Vite base mismatch::Set base: \"${EXPECTED_BASE}\" in vite.config.js"
          fi

          if grep -R -n -E "BrowserRouter.*basename=.*import\.meta\.env\.BASE_URL" src >/dev/null 2>&1; then
            echo "‚úÖ Router basename OK" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Router basename missing. Use <BrowserRouter basename={import.meta.env.BASE_URL}>" >> $GITHUB_STEP_SUMMARY
            echo "::warning title=Router basename missing::Use import.meta.env.BASE_URL"
          fi

      - name: Build üîß
        run: npm run build

      - name: Dist sanity check
        shell: bash
        run: |
          echo "## Dist checks" >> $GITHUB_STEP_SUMMARY
          test -f dist/index.html || (echo "‚ùå dist/index.html missing" >> $GITHUB_STEP_SUMMARY; exit 1)

          if grep -q "/src/main.jsx" dist/index.html; then
            echo "‚ùå dist/index.html references /src/main.jsx (DEV HTML!)" >> $GITHUB_STEP_SUMMARY
            echo "::error title=DEV index.html detected::dist/index.html references /src/main.jsx"
            exit 1
          else
            echo "‚úÖ No /src/main.jsx in dist" >> $GITHUB_STEP_SUMMARY
          fi

          if ! grep -E -q "assets/.+\.js" dist/index.html; then
            echo "‚ùå No assets/*.js references ‚Äî build broken?" >> $GITHUB_STEP_SUMMARY
            echo "::error title=No compiled assets::dist/index.html lacks assets/*.js"
            exit 1
          else
            echo "‚úÖ Compiled JS found (assets/*.js)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### First lines of dist/index.html" >> $GITHUB_STEP_SUMMARY
          head -n 15 dist/index.html | sed 's/</\&lt;/g' | sed 's/>/\&gt;/g' >> $GITHUB_STEP_SUMMARY

          # wyciƒÖgnij g≈Ç√≥wny JS i sprawd≈∫, czy istnieje
          MAINJS=$(grep -Eo "assets/[a-zA-Z0-9\-\_]+\.js" dist/index.html | head -n1 || true)
          if [ -n "$MAINJS" ] && [ -f "dist/$MAINJS" ]; then
            echo "‚úÖ Main asset present: $MAINJS" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Main asset missing in dist: $MAINJS" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload dist artifact üì¶
        uses: actions/upload-artifact@v4
        with:
          name: dist-artifact
          path: dist
          if-no-files-found: error
          retention-days: 7

      - name: Read GH Pages config
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## GH Pages config" >> $GITHUB_STEP_SUMMARY
          gh api "repos/${OWNER}/${REPO_NAME}/pages" > /tmp/pages.json 2>/dev/null || true
          if [ -s /tmp/pages.json ]; then
            BRANCH=$(jq -r '.source.branch // empty' /tmp/pages.json)
            FOLDER=$(jq -r '.source.path // empty' /tmp/pages.json)
            URL=$(jq -r '.html_url // empty' /tmp/pages.json)
            echo "- Source: ${BRANCH:-unknown} ${FOLDER:-/}" >> $GITHUB_STEP_SUMMARY
            echo "- URL: ${URL:-n/a}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Pages not configured yet (or no permission to read)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Live probe (best-effort)
        if: ${{ github.event_name != 'pull_request' }}
        shell: bash
        run: |
          URL="https://${OWNER}.github.io/${REPO_NAME}/"
          echo "## Live check" >> $GITHUB_STEP_SUMMARY
          echo "- Checking ${URL}" >> $GITHUB_STEP_SUMMARY
          code=$(curl -s -o /tmp/live.html -w "%{http_code}" "$URL" || true)
          echo "- HTTP: $code" >> $GITHUB_STEP_SUMMARY
          if [ "$code" != "200" ] && [ "$code" != "301" ] && [ "$code" != "302" ]; then
            echo "‚ö†Ô∏è Not OK yet (Pages cache or misconfig). Most common fixes:" >> $GITHUB_STEP_SUMMARY
            echo "- Set Pages source to gh-pages / root OR use Actions deploy" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure workflow deploys **dist/**, not repo root" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure Vite base is ${EXPECTED_BASE}" >> $GITHUB_STEP_SUMMARY
          else
            if grep -E "assets/.+\.js" /tmp/live.html >/dev/null 2>&1; then
              echo "‚úÖ Live HTML includes assets/*.js (good)" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Live HTML missing assets/*.js ‚Äî often serving DEV HTML" >> $GITHUB_STEP_SUMMARY
            fi
          fi
